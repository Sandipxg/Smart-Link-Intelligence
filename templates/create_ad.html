{% extends "base.html" %}
{% block content %}
<div class="container py-4">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="fw-bold mb-1">
        <i class="bi bi-megaphone text-primary me-2"></i>Create Personalized Ads
      </h2>
      <p class="text-muted mb-0">Design custom ads that will be shown to non-premium users visiting your links</p>
    </div>
    <div class="text-end">
      <span class="badge bg-info">
        <i class="bi bi-info-circle me-1"></i>Shown to Free Users Only
      </span>
    </div>
  </div>

  <!-- Info Alert -->
  <div class="alert alert-info d-flex align-items-start mb-4">
    <i class="bi bi-lightbulb-fill text-info me-3 mt-1"></i>
    <div>
      <h6 class="alert-heading mb-2">How Personalized Ads Work</h6>
      <p class="mb-2">Your custom ads will be displayed to non-premium users when they visit shortened links. The grid
        system works as follows:</p>
      <ul class="mb-2">
        <li><strong>Position 1 (Large Ad):</strong> Main featured ad at the top - most prominent placement</li>
        <li><strong>Position 2 & 3 (Small Ads):</strong> Side-by-side ads below the main ad - only shown if multiple ads
          exist</li>
        <li><strong>Smart Display:</strong> If only 1 ad exists, only the large ad is shown. Grid layout activates with
          2+ ads</li>
        <li><strong>Empty Positions:</strong> When grid is active but positions are empty, "Want your ads here?"
          placeholders appear</li>
      </ul>
      <p class="mb-0">This is a great way to promote your products, drive traffic, and build brand awareness within the
        LinkPro community!</p>
    </div>
  </div>

  <!-- Stats Cards -->
  {% if user_ads %}
  <div class="row g-3 mb-4">
    <div class="col-md-3">
      <div class="card bg-primary text-white">
        <div class="card-body text-center">
          <i class="bi bi-collection fs-2 mb-2"></i>
          <h4 class="mb-0">{{ total_ads }}</h4>
          <small>Total Ads</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-success text-white">
        <div class="card-body text-center">
          <i class="bi bi-play-circle fs-2 mb-2"></i>
          <h4 class="mb-0">{{ active_ads }}</h4>
          <small>Active Ads</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-warning text-white">
        <div class="card-body text-center">
          <i class="bi bi-pause-circle fs-2 mb-2"></i>
          <h4 class="mb-0">{{ total_ads - active_ads }}</h4>
          <small>Inactive Ads</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-info text-white">
        <div class="card-body text-center">
          <i class="bi bi-eye fs-2 mb-2"></i>
          <h4 class="mb-0">{{ (active_ads / total_ads * 100)|round|int if total_ads > 0 else 0 }}%</h4>
          <small>Active Rate</small>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <div class="row">
    <!-- Ad Creation Form -->
    <div class="col-lg-8">
      <div class="card shadow-sm border-0 mb-4">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">
            <i class="bi bi-palette me-2"></i>Design Your Ad
          </h5>
        </div>
        <div class="card-body p-4">
          <form method="POST" action="{{ url_for('submit_ad') }}" id="adForm" enctype="multipart/form-data">
            <!-- Ad Type Selection -->
            <div class="row g-3 mb-4">
              <div class="col-12">
                <label class="form-label fw-semibold">Ad Type <span class="text-danger">*</span></label>
                <div class="btn-group w-100" role="group" aria-label="Ad type selection">
                  <input type="radio" class="btn-check" name="ad_type" id="custom_ad" value="custom" checked
                    onchange="toggleAdType()">
                  <label class="btn btn-outline-primary" for="custom_ad">
                    <i class="bi bi-palette me-2"></i>Custom Design
                  </label>

                  <input type="radio" class="btn-check" name="ad_type" id="image_ad" value="image"
                    onchange="toggleAdType()">
                  <label class="btn btn-outline-primary" for="image_ad">
                    <i class="bi bi-image me-2"></i>Upload Image
                  </label>
                </div>
                <div class="form-text">Choose between creating a custom designed ad or uploading your own image</div>
              </div>
            </div>

            <div class="row g-3">
              <!-- Basic Ad Information (Always Required) -->
              <div class="col-md-6">
                <label class="form-label fw-semibold">Ad Title <span class="text-danger">*</span></label>
                <input type="text" name="title" class="form-control" placeholder="Amazing Product Launch!"
                  maxlength="50" required id="adTitle" oninput="updatePreview()">
                <div class="form-text">Maximum 50 characters</div>
              </div>

              <div class="col-md-6">
                <label class="form-label fw-semibold">Call-to-Action Text <span class="text-danger">*</span></label>
                <input type="text" name="cta_text" class="form-control" placeholder="Try Now!" maxlength="20" required
                  id="ctaText" oninput="updatePreview()">
                <div class="form-text">Maximum 20 characters</div>
              </div>

              <div class="col-12">
                <label class="form-label fw-semibold">Description <span class="text-danger">*</span></label>
                <textarea name="description" class="form-control" rows="3"
                  placeholder="Discover amazing features that will boost your productivity..." maxlength="150" required
                  id="adDescription" oninput="updatePreview()"></textarea>
                <div class="form-text">Maximum 150 characters</div>
              </div>

              <div class="col-12">
                <label class="form-label fw-semibold">Target URL <span class="text-danger">*</span></label>
                <input type="url" name="cta_url" class="form-control"
                  placeholder="https://your-website.com/landing-page" required id="ctaUrl">
                <div class="form-text">Where users will be redirected when they click your ad</div>
              </div>

              <!-- Image Upload Section (Hidden by default) -->
              <div class="col-12" id="imageUploadSection" style="display: none;">
                <hr class="my-4">
                <h6 class="fw-bold mb-3">
                  <i class="bi bi-cloud-upload me-2"></i>Upload Your Ad Image
                </h6>
                <div class="mb-3">
                  <label class="form-label fw-semibold">Ad Image</label>
                  <input type="file" name="ad_image" class="form-control" accept="image/*" id="adImageFile"
                    onchange="previewImage()">
                  <div class="form-text">
                    <strong>Image Upload:</strong><br>
                    ‚Ä¢ Images will be displayed with CSS-based cropping to fit ad spaces<br>
                    ‚Ä¢ For best results, use images with 4:3 aspect ratio (800x600px recommended)<br>
                    ‚Ä¢ Large Ad: Displays prominently at the top<br>
                    ‚Ä¢ Small Ads: Automatically scaled to fit smaller spaces<br>
                    ‚Ä¢ Supported formats: PNG, JPG, JPEG, GIF, WebP<br>
                    ‚Ä¢ Maximum file size: 16MB
                  </div>
                </div>
                <div id="imagePreview" class="mb-3" style="display: none;">
                  <img id="previewImg" src="" alt="Preview" class="img-thumbnail"
                    style="max-width: 300px; max-height: 200px;">
                </div>
              </div>

              <!-- Custom Design Section (Visible by default) -->
              <div id="customDesignSection">
                <div class="col-12">
                  <hr class="my-4">
                  <h6 class="fw-bold mb-3">
                    <i class="bi bi-brush me-2"></i>Customize Appearance
                  </h6>
                </div>

                <div class="col-md-4">
                  <label class="form-label fw-semibold">Background Color</label>
                  <div class="d-flex gap-2 align-items-center">
                    <input type="color" name="background_color" class="form-control form-control-color" value="#667eea"
                      id="bgColor" onchange="updatePreview()">
                    <input type="text" class="form-control form-control-sm" value="#667eea" id="bgColorText"
                      onchange="syncColor('bg')" style="width: 100px;">
                  </div>
                </div>

                <div class="col-md-4">
                  <label class="form-label fw-semibold">Text Color</label>
                  <div class="d-flex gap-2 align-items-center">
                    <input type="color" name="text_color" class="form-control form-control-color" value="#ffffff"
                      id="textColor" onchange="updatePreview()">
                    <input type="text" class="form-control form-control-sm" value="#ffffff" id="textColorText"
                      onchange="syncColor('text')" style="width: 100px;">
                  </div>
                </div>

                <div class="col-md-4">
                  <label class="form-label fw-semibold">Icon</label>
                  <select name="icon" class="form-select" id="adIcon" onchange="updatePreview()">
                    <option value="üöÄ">üöÄ Rocket</option>
                    <option value="‚≠ê">‚≠ê Star</option>
                    <option value="üíé">üíé Diamond</option>
                    <option value="üéØ">üéØ Target</option>
                    <option value="üî•">üî• Fire</option>
                    <option value="üí°">üí° Bulb</option>
                    <option value="üéâ">üéâ Party</option>
                    <option value="üèÜ">üèÜ Trophy</option>
                    <option value="üí∞">üí∞ Money</option>
                    <option value="üéÅ">üéÅ Gift</option>
                  </select>
                </div>
              </div>

              <!-- Grid Position -->
              <div class="col-12">
                <hr class="my-4">
                <h6 class="fw-bold mb-3">
                  <i class="bi bi-grid-3x3 me-2"></i>Ad Placement Settings
                </h6>
              </div>

              <div class="col-md-6">
                <label class="form-label fw-semibold">Grid Position <span class="text-danger">*</span></label>
                <select name="grid_position" class="form-select" required>
                  <option value="1">Position 1 - Large Ad (Top)</option>
                  <option value="2">Position 2 - Small Ad (Bottom Left)</option>
                  <option value="3">Position 3 - Small Ad (Bottom Right)</option>
                </select>
                <div class="form-text">Choose where your ad will appear in the grid layout</div>
              </div>

              <div class="col-md-6">
                <div class="alert alert-info mb-0">
                  <small>
                    <i class="bi bi-info-circle me-1"></i>
                    <strong>Grid Logic:</strong> If only 1 ad exists, only the large ad shows.
                    With 2+ ads, the grid activates. Empty positions show "Want your ads here?" placeholders.
                  </small>
                </div>
              </div>

              <div class="col-12 mt-4">
                <button type="submit" class="btn btn-primary btn-lg">
                  <i class="bi bi-plus-circle me-2"></i>Create Ad
                </button>
                <button type="reset" class="btn btn-outline-secondary btn-lg ms-2" onclick="resetPreview()">
                  <i class="bi bi-arrow-clockwise me-2"></i>Reset
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Live Preview -->
    <div class="col-lg-4">
      <div class="sticky-top" style="top: 2rem;">
        <div class="card shadow-sm border-0">
          <div class="card-header bg-success text-white">
            <h6 class="mb-0">
              <i class="bi bi-eye me-2"></i>Live Preview
            </h6>
          </div>
          <div class="card-body p-3">
            <div class="ad-preview" id="adPreview">
              <div class="ad-preview-content">
                <div class="d-flex align-items-center mb-2">
                  <span class="preview-icon me-2">üöÄ</span>
                  <h6 class="preview-title mb-0">Amazing Product Launch!</h6>
                </div>
                <p class="preview-description mb-3">Discover amazing features that will boost your productivity...</p>
                <button class="btn btn-sm preview-cta">Try Now!</button>
              </div>
            </div>
            <div class="mt-3">
              <small class="text-muted">
                <i class="bi bi-info-circle me-1"></i>
                This is how your ad will appear to non-premium users
              </small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Existing Ads -->
  {% if user_ads %}
  <div class="card shadow-sm border-0 mt-4">
    <div class="card-header bg-light">
      <h5 class="mb-0">
        <i class="bi bi-collection me-2"></i>Your Ads ({{ user_ads|length }})
      </h5>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th>Preview</th>
              <th>Title</th>
              <th>Type</th>
              <th>Description</th>
              <th>Target URL</th>
              <th>Position</th>
              <th>Status</th>
              <th>Created</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for ad in user_ads %}
            <tr>
              <td>
                {% if ad.ad_type == 'image' and ad.image_filename %}
                <img src="{{ url_for('uploaded_file', filename=ad.image_filename) }}" alt="{{ ad.title }}"
                  class="img-thumbnail" style="width: 60px; height: 40px; object-fit: cover;">
                {% else %}
                <div class="mini-ad-preview" style="background: {{ ad.background_color }}; color: {{ ad.text_color }};">
                  <span class="me-1">{{ ad.icon }}</span>
                  <small>{{ ad.title[:15] }}...</small>
                </div>
                {% endif %}
              </td>
              <td>
                <strong>{{ ad.title }}</strong>
              </td>
              <td>
                {% if ad.ad_type == 'image' %}
                <span class="badge bg-info">
                  <i class="bi bi-image me-1"></i>Image
                </span>
                {% else %}
                <span class="badge bg-primary">
                  <i class="bi bi-palette me-1"></i>Custom
                </span>
                {% endif %}
              </td>
              <td>
                <small class="text-muted">{{ ad.description[:50] }}{% if ad.description|length > 50 %}...{% endif
                  %}</small>
              </td>
              <td>
                <a href="{{ ad.cta_url }}" target="_blank" class="text-decoration-none small">
                  {{ ad.cta_url[:30] }}{% if ad.cta_url|length > 30 %}...{% endif %}
                  <i class="bi bi-box-arrow-up-right ms-1"></i>
                </a>
              </td>
              <td>
                {% if ad.grid_position == 1 %}
                <span class="badge bg-primary">Large (Top)</span>
                {% elif ad.grid_position == 2 %}
                <span class="badge bg-info">Small (Left)</span>
                {% elif ad.grid_position == 3 %}
                <span class="badge bg-info">Small (Right)</span>
                {% else %}
                <span class="badge bg-secondary">Position {{ ad.grid_position }}</span>
                {% endif %}
              </td>
              <td>
                {% if ad.is_active %}
                <span class="badge bg-success">Active</span>
                {% else %}
                <span class="badge bg-secondary">Inactive</span>
                {% endif %}
              </td>
              <td>
                <small class="text-muted">{{ ad.created_at[:10] }}</small>
              </td>
              <td>
                <div class="btn-group btn-group-sm">
                  <form method="POST" action="{{ url_for('toggle_ad', ad_id=ad.id) }}" class="d-inline">
                    <button type="submit" class="btn btn-outline-primary btn-sm">
                      {% if ad.is_active %}
                      <i class="bi bi-pause"></i>
                      {% else %}
                      <i class="bi bi-play"></i>
                      {% endif %}
                    </button>
                  </form>
                  <form method="POST" action="{{ url_for('delete_ad', ad_id=ad.id) }}" class="d-inline"
                    onsubmit="return confirm('Are you sure you want to delete this ad?')">
                    <button type="submit" class="btn btn-outline-danger btn-sm">
                      <i class="bi bi-trash"></i>
                    </button>
                  </form>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  {% endif %}
</div>

<style>
  .ad-preview {
    border-radius: 10px;
    padding: 1.5rem;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    min-height: 150px;
  }

  .ad-preview-content {
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: center;
  }

  .preview-icon {
    font-size: 1.5rem;
  }

  .preview-title {
    font-weight: bold;
    font-size: 1.1rem;
  }

  .preview-description {
    font-size: 0.9rem;
    opacity: 0.9;
    line-height: 1.4;
  }

  .preview-cta {
    background: rgba(255, 255, 255, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.3);
    color: white;
    font-weight: bold;
    border-radius: 20px;
    padding: 0.5rem 1rem;
    align-self: flex-start;
  }

  .mini-ad-preview {
    padding: 0.25rem 0.5rem;
    border-radius: 5px;
    font-size: 0.75rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 120px;
  }

  .form-control-color {
    width: 50px;
    height: 38px;
    border-radius: 6px;
  }
</style>

<script src="{{ url_for('static', filename='js/ads.js') }}"></script>
{% endblock %}