<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description"
    content="Comprehensive behavioral analytics and explainable insights for intelligent short links">
  <title>Link Analytics - {{ link.code }} - Smart Link Intelligence</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/analytics_theme.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script type="text/javascript" src="https://unpkg.com/qr-code-styling@1.5.0/lib/qr-code-styling.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>

<body class="bg-light min-vh-100">
  <!-- Navigation Header -->
  <header class="bg-white border-bottom sticky-top shadow-sm">
    <nav class="container-fluid px-4">
      <div class="d-flex align-items-center justify-content-between py-3">
        <!-- Logo -->
        <div class="d-flex align-items-center gap-3">
          <div class="bg-primary rounded-3 p-2">
            <svg width="32" height="32" viewBox="0 0 40 40" fill="none">
              <path d="M12 20L18 26L28 14" stroke="white" stroke-width="3" stroke-linecap="round" />
            </svg>
          </div>
          <div>
            <h1 class="h5 mb-0 fw-bold">Smart Link Intelligence</h1>
            <p class="small text-muted mb-0">Behavioral Analytics Platform</p>
          </div>
        </div>

        <!-- Navigation -->
        <div class="d-flex align-items-center gap-2">
          {% if is_admin %}
          <a href="{{ url_for('admin.user_detail', user_id=link.user_id) }}" class="btn btn-outline-secondary btn-sm">
            ← Back to User
          </a>
          {% else %}
          <a href="{{ url_for('main.index') }}" class="btn btn-outline-secondary btn-sm">
            ← Dashboard
          </a>
          {% endif %}
          {% if g.user %}
          <span class="text-muted small">{{ g.user.username }}</span>
          <a href="{{ url_for('auth.logout') }}" class="btn btn-outline-danger btn-sm">Logout</a>
          {% endif %}
        </div>
      </div>
    </nav>
  </header>

  <!-- Main Content -->
  <main class="container-fluid px-4 py-4">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('main.index') }}">Dashboard</a></li>
        <li class="breadcrumb-item active">Analytics</li>
      </ol>
    </nav>

    <!-- Link Header Information: Hero Stats Layout -->
    <style>
      .hero-section {
        background: white;
        border-radius: 1.5rem;
        border: 1px solid rgba(0, 0, 0, 0.05);
        overflow: hidden;
      }

      .info-card {
        background: #f8fafc;
        border-radius: 1rem;
        padding: 1rem;
        height: 100%;
        transition: transform 0.2s, box-shadow 0.2s;
        border: 1px solid rgba(0, 0, 0, 0.03);
      }

      .info-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      }

      .trust-gauge-container {
        position: relative;
        width: 150px;
        height: 150px;
        margin: 0 auto;
      }

      .gauge-svg {
        transform: rotate(-90deg);
        width: 100%;
        height: 100%;
      }

      .gauge-bg {
        fill: none;
        stroke: #e2e8f0;
        stroke-width: 3;
      }

      .gauge-fill {
        fill: none;
        stroke: #22c55e;
        stroke-width: 3;
        stroke-linecap: round;
        transition: stroke-dasharray 1s ease-out;
      }

      .gauge-text {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
      }

      .copy-pill {
        cursor: pointer;
        transition: all 0.2s;
      }

      .copy-pill:hover {
        background: #e2e8f0 !important;
      }

      .action-bar {
        background: #f1f5f9;
        border-top: 1px solid rgba(0, 0, 0, 0.05);
        padding: 1rem 1.5rem;
      }
    </style>

    <section class="hero-section shadow-sm mb-4">
      <div class="px-4 pt-4 pb-3">
        <div class="row align-items-center g-4">
          <!-- Identity & Primary Info -->
          <div class="col-xl-6 col-lg-12">
            <div class="d-flex align-items-center mb-4">
              <div class="d-flex align-items-center gap-3">
                <div class="bg-primary bg-opacity-10 p-2 rounded-3">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    class="text-primary">
                    <path
                      d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z">
                    </path>
                    <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                    <line x1="12" y1="22.08" x2="12" y2="12"></line>
                  </svg>
                </div>
                <div>
                  <div class="d-flex align-items-baseline gap-2">
                    <h2 class="h3 fw-bold mb-0">Link Analytics</h2>
                    <span class="text-muted small font-monospace">({{ link.code }})</span>
                  </div>
                  <span class="badge bg-success rounded-pill px-3 mt-1">{{ link.state }}</span>
                </div>
              </div>
            </div>

            <div class="row g-3">
              <!-- Smart Link Copy Card -->
              <div class="col-12">
                <div class="info-card bg-primary bg-opacity-10 border-primary border-opacity-10">
                  <div class="d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center gap-3">
                      <div class="bg-primary text-white p-2 rounded-circle"
                        style="width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">
                        <i class="bi bi-link-45deg"></i>
                      </div>
                      <div>
                        <span class="text-muted small d-block fw-bold text-uppercase">Smart Link</span>
                        <code class="text-primary fw-bold"
                          style="font-size: 1.1rem;">{{ url_for('links.redirect_link', code=link.code, _external=True) }}</code>
                      </div>
                    </div>
                    <button class="btn btn-primary d-flex align-items-center gap-2 px-4 rounded-pill shadow-sm"
                      onclick="navigator.clipboard.writeText('{{ url_for('links.redirect_link', code=link.code, _external=True) }}'); this.innerHTML='<i class=\'bi bi-check2-all\'></i> Copied'; setTimeout(()=>this.innerHTML='<i class=\'bi bi-clipboard\'></i> Copy Link', 2000)">
                      <i class="bi bi-clipboard"></i> Copy Link
                    </button>
                  </div>
                </div>
              </div>

              <!-- Original URL Card -->
              <div class="col-md-6">
                <div class="info-card">
                  <div class="d-flex align-items-center gap-2 mb-2">
                    <i class="bi bi-globe2 text-muted"></i>
                    <span class="text-muted small fw-bold text-uppercase">Original Target</span>
                  </div>
                  <a href="{{ link.primary_url }}" target="_blank"
                    class="text-primary text-decoration-none fw-medium text-truncate d-block">
                    {{ link.primary_url }}
                  </a>
                </div>
              </div>
              <!-- Behavior Rule Card -->
              <div class="col-md-6">
                <div class="info-card">
                  <div class="d-flex align-items-center gap-2 mb-2">
                    <i class="bi bi-shield-check text-muted"></i>
                    <span class="text-muted small fw-bold text-uppercase">Behavior Engine</span>
                  </div>
                  <div class="d-flex align-items-center gap-2">
                    <span class="badge bg-info text-white rounded-pill">{{ behavior_rule.rule_name if behavior_rule else
                      'Direct' }}</span>
                    {% if behavior_rule %}
                    <small class="text-muted text-truncate">{{ behavior_rule.interested_threshold }}+ visits for
                      Interest</small>
                    {% endif %}
                  </div>
                </div>
              </div>
              <!-- Clicks Card -->
              <div class="col-md-3 col-6">
                <div class="info-card text-center">
                  <span class="text-muted small d-block mb-1">Total Clicks</span>
                  <span class="h3 fw-bold mb-0 text-dark">{{ "{:,}".format(totals.total or 0) }}</span>
                </div>
              </div>
              <!-- Visitors Card -->
              <div class="col-md-3 col-6">
                <div class="info-card text-center">
                  <span class="text-muted small d-block mb-1 text-indigo">Unique Visitors</span>
                  <span class="h3 fw-bold mb-0 text-indigo">{{ "{:,}".format(totals.unique_visitors or 0) }}</span>
                </div>
              </div>
              <!-- Created Card -->
              <div class="col-md-6">
                <div class="info-card">
                  <div class="d-flex align-items-center justify-content-between">
                    <div>
                      <span class="text-muted small d-block mb-0 text-uppercase fw-bold">Timeline</span>
                      <small class="text-dark">Created on <span class="local-time">{{ link.created_at }}</span></small>
                    </div>
                    <i class="bi bi-calendar3 text-muted"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Report & QR Section -->
          <!-- Middle Column: Smart Link QR -->
          <div class="col-xl-3 col-lg-6">
            <div class="card bg-white border-0 shadow-sm h-100 rounded-4 py-4">
              <div class="card-body d-flex flex-column align-items-center justify-content-center text-center">
                <div class="bg-light p-3 rounded-4 shadow-sm border mb-3 position-relative group">
                  <div id="main-qr-placeholder">
                    <img
                      src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data={{ url_for('links.redirect_link', code=link.code, _external=True) }}"
                      alt="QR" width="120" height="120">
                  </div>
                  <button class="btn btn-sm btn-white border position-absolute top-0 end-0 m-2 rounded-circle shadow-sm"
                    data-bs-toggle="modal" data-bs-target="#qrCustomizeModal" title="Customize QR">
                    <i class="bi bi-palette-fill text-primary"></i>
                  </button>
                </div>
                <h5 class="h6 fw-bold text-dark mb-1">Smart Link QR</h5>
                <p class="small text-muted mb-3">Customize & Share</p>
                <button class="btn btn-primary rounded-pill px-4 py-2 shadow-sm" data-bs-toggle="modal"
                  data-bs-target="#qrCustomizeModal">
                  <i class="bi bi-palette-fill me-2"></i>Customize Design
                </button>
              </div>
            </div>
          </div>

          <!-- Right Column: Report Section -->
          <div class="col-xl-3 col-lg-6">
            <div class="card bg-light border-0 h-100 rounded-4 py-4">
              <div class="card-body d-flex flex-column align-items-center justify-content-center text-center">
                <div class="bg-white p-3 rounded-4 shadow-sm border mb-4">
                  <img
                    src="https://api.qrserver.com/v1/create-qr-code/?size=120x120&data={{ url_for('links.export_csv', code_id=link.code, _external=True) }}"
                    alt="QR" width="120" height="120">
                </div>
                <h5 class="h6 fw-bold text-dark mb-1">Download Report</h5>
                <p class="small text-muted mb-4 px-3">Scan QR or click below to export detailed link analytics</p>

                <div class="w-100 px-3 d-grid gap-2">
                  <a href="{{ url_for('links.export_csv', code_id=link.code) }}"
                    class="btn btn-dark rounded-pill py-2 d-flex align-items-center justify-content-center gap-2">
                    <i class="bi bi-cloud-arrow-down-fill"></i> Download CSV
                  </a>
                  <button class="btn btn-outline-dark rounded-pill py-2"
                    data-csv-url="{{ url_for('links.export_csv', code_id=link.code, _external=True) }}"
                    onclick="navigator.clipboard.writeText(this.dataset.csvUrl); alert('CSV Link Copied!')">
                    <i class="bi bi-link-45deg"></i> Copy CSV URL
                  </button>
                  <button
                    class="btn btn-danger rounded-pill py-2 d-flex align-items-center justify-content-center gap-2"
                    onclick="downloadPDF()">
                    <i class="bi bi-file-earmark-pdf-fill"></i> Download PDF Report
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      </div>
      </div>
    </section>

    <!-- Analytics Visualizations -->
    <section class="mb-4">
      <h3 class="h5 fw-bold mb-3">Behavioral Analytics Visualizations</h3>

      <!-- Bento Grid Layout -->
      <div class="row g-3">

        <!-- Row 1: Hero Metrics (Traffic & Quality) -->
        <div class="col-lg-8">
          <div class="card shadow-sm h-100">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="h6 fw-bold mb-0">Engagement Trends (Daily)</h4>
                <span class="badge bg-info bg-opacity-10 text-info">Last 7 Days</span>
              </div>
              <div style="height: 300px;">
                <canvas id="dailyEngagementChart"></canvas>
              </div>
              <div class="mt-3 p-3 bg-light rounded border border-light">
                <p class="small mb-0 text-muted"><strong>Insight:</strong> {{ weekend_insight }}</p>
              </div>
            </div>
          </div>
        </div>

        <div class="col-lg-4">
          <div class="card shadow-sm h-100">
            <div class="card-body d-flex flex-column">
              <div class="mb-3">
                <h4 class="h6 fw-bold mb-0">Traffic Quality</h4>
                <p class="small text-muted mb-0">Human vs Suspicious</p>
              </div>
              <div class="position-relative d-flex justify-content-center" style="height: 200px;">
                <canvas id="trafficQualityChart"></canvas>
                <!-- Centered Score for Gauge -->
                {% set total_clicks = totals.total or 1 %}
                {% set suspicious = totals.suspicious or 0 %}
                {% set human_percentage = (((total_clicks - suspicious) * 100) / total_clicks)|round|int %}
                <div class="position-absolute text-center" style="bottom: 40px;">
                  <h3 class="display-5 fw-bold text-success mb-0" style="line-height: 1;">{{ human_percentage }}%</h3>
                  <p class="small text-muted mb-0 fw-bold">Human Score</p>
                </div>
              </div>
              <div class="d-flex justify-content-center gap-3 mt-n3 pb-2">
                <div class="d-flex align-items-center">
                  <span class="d-inline-block rounded-circle me-1"
                    style="width: 10px; height: 10px; background-color: #22c55e;"></span>
                  <span class="small text-muted">Human</span>
                </div>
                <div class="d-flex align-items-center">
                  <span class="d-inline-block rounded-circle me-1"
                    style="width: 10px; height: 10px; background-color: #ef4444;"></span>
                  <span class="small text-muted">Suspicious</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Row 2: Secondary Metrics (Square Cards) -->
        <div class="col-lg-4">
          <div class="card shadow-sm h-100">
            <div class="card-body">
              <h4 class="h6 fw-bold mb-3">User Intent</h4>
              <style>
                .funnel-container {
                  display: flex;
                  flex-direction: column;
                  align-items: center;
                  justify-content: center;
                  height: 100%;
                  width: 100%;
                }

                .funnel-level {
                  position: relative;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  color: white;
                  font-weight: bold;
                  font-size: 0.85rem;
                  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
                  transition: all 0.3s ease;
                  cursor: default;
                }

                .funnel-level:hover {
                  filter: brightness(1.1);
                  transform: scale(1.02);
                  z-index: 2;
                }

                /* Curious - Top */
                .funnel-curious {
                  width: 90%;
                  height: 60px;
                  background: linear-gradient(180deg, #9ca3af 0%, #6b7280 100%);
                  clip-path: polygon(0 0, 100% 0, 85% 100%, 15% 100%);
                  margin-bottom: 4px;
                }

                /* Interested - Middle */
                .funnel-interested {
                  width: 70%;
                  /* 70% is roughly 85% - 15% of the previous width? Visual approximation */
                  height: 60px;
                  background: linear-gradient(180deg, #fcd34d 0%, #f59e0b 100%);
                  clip-path: polygon(0 0, 100% 0, 80% 100%, 20% 100%);
                  margin-bottom: 4px;
                }

                /* Engaged - Bottom */
                .funnel-engaged {
                  width: 42%;
                  height: 60px;
                  background: linear-gradient(180deg, #4ade80 0%, #22c55e 100%);
                  clip-path: polygon(0 0, 100% 0, 50% 100%, 50% 100%);
                  /* Triangle tip */
                }

                .funnel-label {
                  position: absolute;
                }
              </style>
              <div class="funnel-container py-2">
                {% set f_curious = analytics_payload.intent.curious or 0 %}
                {% set f_interested = analytics_payload.intent.interested or 0 %}
                {% set f_engaged = analytics_payload.intent.engaged or 0 %}

                <div class="funnel-level funnel-curious" title="Curious: {{ f_curious }}">
                  <span class="funnel-label">Curious: {{ f_curious }}</span>
                </div>
                <div class="funnel-level funnel-interested" title="Interested: {{ f_interested }}">
                  <span class="funnel-label">Interested: {{ f_interested }}</span>
                </div>
                <div class="funnel-level funnel-engaged" title="Engaged: {{ f_engaged }}">
                  <span class="funnel-label" style="top: 10px;">Engaged: {{ f_engaged }}</span>
                </div>
              </div>
              <div class="mt-3 text-center">
                <div class="row g-1">
                  <div class="col-4">
                    <div class="p-1 rounded bg-secondary bg-opacity-10">
                      <div class="small fw-bold">{{ totals.curious or 0 }}</div>
                      <div class="small text-muted" style="font-size: 10px;">Curious</div>
                    </div>
                  </div>
                  <div class="col-4">
                    <div class="p-1 rounded bg-warning bg-opacity-10">
                      <div class="small fw-bold">{{ totals.interested or 0 }}</div>
                      <div class="small text-muted" style="font-size: 10px;">Interest</div>
                    </div>
                  </div>
                  <div class="col-4">
                    <div class="p-1 rounded bg-success bg-opacity-10">
                      <div class="small fw-bold">{{ totals.engaged or 0 }}</div>
                      <div class="small text-muted" style="font-size: 10px;">Engaged</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-lg-4">
          <div class="card shadow-sm h-100">
            <div class="card-body">
              <h4 class="h6 fw-bold mb-3">Device Breakdown</h4>
              <div class="d-flex flex-column justify-content-center h-100" id="deviceBarContainer">
                <div class="d-flex justify-content-between px-2 mb-3 align-items-end">
                  <div class="text-center" style="width: 48%;">
                    <div id="deviceLabelMobile" style="min-height: 50px;">
                      <i class="bi bi-phone-vibrate fs-3 d-block mb-1 text-muted"></i>
                      <span class="fs-5 fw-bold text-muted">0%</span>
                    </div>
                  </div>
                  <div class="text-center" style="width: 48%;">
                    <div id="deviceLabelDesktop" style="min-height: 50px;">
                      <i class="bi bi-laptop fs-3 d-block mb-1 text-muted"></i>
                      <span class="fs-5 fw-bold text-muted">0%</span>
                    </div>
                  </div>
                </div>

                <!-- The Progress Bar -->
                <div class="progress" style="height: 24px; border-radius: 12px; overflow: hidden; font-size: 0;">
                  <div id="deviceBarMobile" class="progress-bar" role="progressbar"
                    style="width: 50%; background: linear-gradient(90deg, #3b82f6 0%, #8b5cf6 100%); transition: width 0.6s ease;">
                  </div>
                  <div id="deviceBarDesktop" class="progress-bar" role="progressbar"
                    style="width: 50%; background: linear-gradient(90deg, #f59e0b 0%, #fbbf24 100%); transition: width 0.6s ease;">
                  </div>
                </div>

                <!-- Stats Row -->
                <div class="d-flex justify-content-between mt-3 px-1">
                  <div class="text-start">
                    <h5 class="mb-0 fw-bold text-dark" id="deviceCountMobile">0</h5>
                    <small class="text-muted">Mobile / Tablet</small>
                  </div>
                  <div class="text-end">
                    <h5 class="mb-0 fw-bold text-dark" id="deviceCountDesktop">0</h5>
                    <small class="text-muted">Desktop</small>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-lg-4">
          <div class="card shadow-sm h-100">
            <div class="card-body">
              <h4 class="h6 fw-bold mb-3">Attention Decay</h4>
              <div style="height: 200px;">
                <canvas id="attentionDecayChart"></canvas>
              </div>
              <div class="mt-3">
                <p class="small text-muted mb-0 mx-auto text-center" style="max-width: 200px;">
                  {% if attention|length > 1 %}Tracking {{ attention|length }} duration points{% else %}Not enough
                  data{% endif %}
                </p>
              </div>
            </div>
          </div>
        </div>

        <!-- Row 3: Geography & Systems (Asymmetrical) -->
        <div class="col-lg-8">
          <div class="card shadow-sm h-100">
            <div class="card-body">
              <h4 class="h6 fw-bold mb-3">Regional Distribution</h4>
              <div class="row align-items-center">
                <div class="col-md-7">
                  <div class="position-relative d-flex align-items-center justify-content-center bg-light rounded"
                    style="height: 250px; overflow: hidden;">
                    <svg id="worldMap" viewBox="0 0 1000 500" style="width: 100%; height: 100%;">
                      <!-- Simple World Map Paths (Abstract) -->
                      <style>
                        .continent-path {
                          fill: #e2e8f0;
                          stroke: #fff;
                          stroke-width: 2;
                          transition: all 0.3s ease;
                        }

                        .continent-path:hover {
                          fill: #cbd5e1;
                          cursor: pointer;
                        }

                        .continent-label {
                          font-family: sans-serif;
                          font-size: 24px;
                          font-weight: bold;
                          fill: #334155;
                          opacity: 0;
                          transition: opacity 0.3s;
                          pointer-events: none;
                          text-anchor: middle;
                          alignment-baseline: middle;
                          text-shadow: 0px 0px 4px rgba(255, 255, 255, 0.8);
                        }

                        .continent-active {
                          fill: #93c5fd !important;
                        }

                        .label-visible {
                          opacity: 1;
                        }
                      </style>

                      <!-- North America -->
                      <path id="path-na" class="continent-path"
                        d="M 50 20 L 300 20 L 250 150 L 150 200 L 50 100 Z M 150 20 L 350 20 L 300 100 L 100 50 Z"
                        d="m 75.9,29.9 83.0,-4.5 94.6,5.3 118.7,42.8 -6.2,25.9 -72.3,16.0 -33.9,74.1 -29.4,32.1 -25.9,-1.8 -21.4,-33.9 -44.6,-32.1 -55.3,-24.1 -8.0,-23.2 z" />
                      <!-- Using a more accurate simplified path set for better visual -->
                      <path id="path-na" class="continent-path"
                        d="M54.9,28.8L158,23.5l113.3,47.3l-5.3,27.7l-71.3,15.2l-33.9,73.1l-30.3,31.2l-25-2.7l-20.5-33l-45.5-31.2l-51.7-25L54.9,28.8z" />
                      <text id="label-na" class="continent-label" x="150" y="100">0</text>

                      <!-- South America -->
                      <path id="path-sa" class="continent-path"
                        d="M228.4,220.8l77.6,35.7l33,87.4l-19.6,90.1l-39.2,27.7l-52.6-32.1l-39.2-105.3L228.4,220.8z" />
                      <text id="label-sa" class="continent-label" x="260" y="320">0</text>

                      <!-- Europe -->
                      <path id="path-eu" class="continent-path" d="M430,30 L550,30 L 580,100 L 500,130 L 420,100 Z"
                        d="m 432.8,28.8 111.5,4.5 41.9,64.2 -76.7,35.7 -70.5,-16.9 z" />
                      <path id="path-eu" class="continent-path"
                        d="M410.5,23.5l140.1,6.2l39.2,69.6l-76.7,35.7l-74.1-14.3L410.5,23.5z" />
                      <text id="label-eu" class="continent-label" x="480" y="80">0</text>

                      <!-- Africa -->
                      <path id="path-af" class="continent-path"
                        d="M417.6,138.7l116,9.8l56.2,56.2l-9.8,118.7l-60.7,51.7l-85.7-34.8l-41-94.6L417.6,138.7z" />
                      <text id="label-af" class="continent-label" x="490" y="230">0</text>

                      <!-- Asia -->
                      <path id="path-as" class="continent-path"
                        d="M592.5,28.8l175.8,10.7l102.6,34.8l-15.2,107.1l-76.7,66l-99.9-10.7l-67.8-67.8L592.5,28.8z" />
                      <text id="label-as" class="continent-label" x="680" y="120">0</text>

                      <!-- Oceania -->
                      <path id="path-oc" class="continent-path"
                        d="M729.9,282.4l112.4-7.1l52.6,58l-12.5,68.7l-70.5,39.2l-77.6-25.9L729.9,282.4z" />
                      <text id="label-oc" class="continent-label" x="800" y="340">0</text>

                    </svg>
                  </div>
                </div>
                <div class="col-md-5">
                  <div class="border rounded p-3" style="max-height: 250px; overflow-y: auto;">
                    <ul class="list-group list-group-flush small">
                      {% for region in region_data[:4] %}
                      <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                        {{ region.location }}
                        <span class="badge bg-light text-dark rounded-pill">{{ region.count }}</span>
                      </li>
                      {% endfor %}
                    </ul>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-lg-4">
          <div class="card shadow-sm h-100">
            <div class="card-body">
              <h4 class="h6 fw-bold mb-3">Top ISPs</h4>
              <div style="height: 180px;">
                <canvas id="ispChart"></canvas>
              </div>
              <div class="mt-3 table-responsive" style="max-height: 100px; overflow-y: auto;">
                <table class="table table-sm table-borderless small mb-0">
                  <tbody>
                    {% for row in isp_data[:5] %}
                    <tr>
                      <td class="text-truncate" style="max-width: 120px;" title="{{ row.provider }}">{{ row.provider }}
                      </td>
                      <td class="text-end fw-bold">{{ row.count }}</td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Row 4: Detailed Analysis (Collapsible or just extra row) -->
        <div class="col-md-6">
          <div class="card shadow-sm h-100">
            <div class="card-body">
              <h4 class="h6 fw-bold mb-3">Hourly Click Patterns</h4>
              <div style="height: 200px;">
                <canvas id="clickFrequencyChart"></canvas>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card shadow-sm h-100">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="h6 fw-bold mb-0">Global Reach (By Country)</h4>
                <span class="badge bg-primary bg-opacity-10 text-primary">Top Locations</span>
              </div>
              <div class="row align-items-center">
                <div class="col-12 col-xl-6 mb-3 mb-xl-0">
                  <div style="height: 200px;">
                    <canvas id="countryChart"></canvas>
                  </div>
                </div>
                <div class="col-12 col-xl-6">
                  <div class="table-responsive border rounded" style="max-height: 200px; overflow-y: auto;">
                    <table class="table table-sm table-hover mb-0" style="font-size: 13px;">
                      <thead class="table-light sticky-top">
                        <tr>
                          <th class="ps-2">Country</th>
                          <th class="text-end pe-2">Users</th>
                        </tr>
                      </thead>
                      <tbody id="countryTableBody">
                        <!-- Populated by JS -->
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </section>

    <!-- Detailed Visitor Log Section (Grabify-like) -->
    <section class="mb-4">
      <div class="card shadow-sm">
        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
          <div>
            <h4 class="h6 fw-bold mb-0">
              <svg width="18" height="18" fill="currentColor" class="me-2" viewBox="0 0 16 16">
                <path
                  d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0zm4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4zm-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10c-2.29 0-3.516.68-4.168 1.332-.678.678-.83 1.418-.832 1.664h10z" />
              </svg>
              Detailed Visitor Log
            </h4>
            <p class="small text-muted mb-0 mt-1">Click on any row to view full details</p>
          </div>
          <div class="d-flex align-items-center gap-2">
            <a href="{{ url_for('links.export_link_analytics_excel', code_id=link.code) }}"
              class="btn btn-outline-light btn-sm">
              <svg width="14" height="14" fill="currentColor" class="me-1" viewBox="0 0 16 16">
                <path
                  d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z" />
                <path
                  d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z" />
              </svg>
              Export to Excel
            </a>
            <span class="badge bg-primary">{{ detailed_visitors|length }} visitors</span>
          </div>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
            <table class="table table-hover table-striped mb-0">
              <thead class="table-light sticky-top" style="top: 0; z-index: 1;">
                <tr>
                  <th class="small fw-bold">Srno</th>
                  <th class="small fw-bold">Time</th>
                  <th class="small fw-bold">IP Address</th>
                  <th class="small fw-bold">Country</th>
                  <th class="small fw-bold">City</th>
                  <th class="small fw-bold">Browser</th>
                  <th class="small fw-bold">ISP</th>
                  <th class="small fw-bold">Coordinate</th>
                </tr>
              </thead>
              <tbody>
                {% for visitor in detailed_visitors %}
                <tr class="visitor-row" style="cursor: pointer;" data-visitor='{{ visitor | tojson }}'
                  onclick="showVisitorModal(this)">
                  <td class="small">{{ loop.index }}</td>
                  <td class="small local-time">{{ visitor.timestamp }}</td>
                  <td class="small font-monospace">{{ visitor.ip_address }}</td>
                  <td class="small">
                    {% if visitor.latitude and visitor.longitude %}
                    <a href="https://www.google.com/maps?q={{ visitor.latitude }},{{ visitor.longitude }}"
                      target="_blank" class="text-decoration-none text-dark" onclick="event.stopPropagation()">
                      {{ visitor.country }}
                    </a>
                    {% else %}
                    {{ visitor.country }}
                    {% endif %}
                  </td>
                  <td class="small">
                    {% if visitor.latitude and visitor.longitude %}
                    <a href="https://www.google.com/maps?q={{ visitor.latitude }},{{ visitor.longitude }}"
                      target="_blank" class="text-decoration-none text-dark" onclick="event.stopPropagation()">
                      {{ visitor.city if visitor.city and visitor.city != 'Unknown' else 'N/A' }}
                    </a>
                    {% else %}
                    {{ visitor.city if visitor.city and visitor.city != 'Unknown' else 'N/A' }}
                    {% endif %}
                  </td>
                  <td class="small">{{ visitor.browser[:30] }}{% if visitor.browser|length > 30 %}...{% endif %}</td>
                  <td class="small">{{ visitor.isp[:25] }}{% if visitor.isp|length > 25 %}...{% endif %}</td>
                  <td class="small">
                    {% if visitor.latitude and visitor.longitude %}
                    <a href="https://www.google.com/maps?q={{ visitor.latitude }},{{ visitor.longitude }}"
                      target="_blank"
                      class="text-decoration-none d-flex align-items-center gap-1 text-primary fw-medium"
                      onclick="event.stopPropagation()">
                      <svg width="12" height="12" fill="currentColor" viewBox="0 0 16 16">
                        <path
                          d="M8 16s6-5.686 6-10A6 6 0 0 0 2 6c0 4.314 6 10 6 10zm0-7a3 3 0 1 1 0-6 3 3 0 0 1 0 6z" />
                      </svg>
                      {{ "{:.4f}".format(visitor.latitude) }}, {{ "{:.4f}".format(visitor.longitude) }}
                    </a>
                    {% else %}
                    <span class="text-muted">N/A</span>
                    {% endif %}
                  </td>
                </tr>
                {% else %}
                <tr>
                  <td colspan="8" class="text-center py-4 text-muted">
                    <svg width="48" height="48" fill="currentColor" class="mb-2 opacity-50" viewBox="0 0 16 16">
                      <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z" />
                      <path
                        d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z" />
                    </svg>
                    <p class="mb-0">No visitor data yet. Share your link to start tracking!</p>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Visitor Details Modal (Grabify-like Advanced Log) -->
  <div class="modal fade" id="visitorModal" tabindex="-1" aria-labelledby="visitorModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-dark text-white">
          <h5 class="modal-title" id="visitorModalLabel">
            <svg width="20" height="20" fill="currentColor" class="me-2" viewBox="0 0 16 16">
              <path
                d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0zm4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4zm-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10c-2.29 0-3.516.68-4.168 1.332-.678.678-.83 1.418-.832 1.664h10z" />
            </svg>
            Advanced Log
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body p-0">
          <table class="table table-bordered mb-0">
            <tbody>
              <tr>
                <th class="bg-light" style="width: 30%;">IP Address</th>
                <td id="modal-ip" class="font-monospace"></td>
              </tr>
              <tr>
                <th class="bg-light">Country</th>
                <td id="modal-country"></td>
              </tr>
              <tr>
                <th class="bg-light">City</th>
                <td id="modal-city"></td>
              </tr>
              <tr>
                <th class="bg-light">Browser</th>
                <td id="modal-browser"></td>
              </tr>
              <tr>
                <th class="bg-light">User Agent</th>
                <td id="modal-useragent" class="small font-monospace text-break"></td>
              </tr>
              <tr>
                <th class="bg-light">Referring URL</th>
                <td id="modal-referrer"></td>
              </tr>
              <tr>
                <th class="bg-light">Host Name</th>
                <td id="modal-hostname" class="font-monospace"></td>
              </tr>
              <tr>
                <th class="bg-light">ISP</th>
                <td id="modal-isp"></td>
              </tr>
              <tr>
                <th class="bg-light">Organization</th>
                <td id="modal-org"></td>
              </tr>
              <tr>
                <th class="bg-light">Timezone</th>
                <td id="modal-timezone"></td>
              </tr>
              <tr>
                <th class="bg-light">Device Type</th>
                <td id="modal-device"></td>
              </tr>
              <tr>
                <th class="bg-light">Behavior</th>
                <td id="modal-behavior"></td>
              </tr>
              <tr>
                <th class="bg-light">Timestamp</th>
                <td id="modal-timestamp"></td>
              </tr>
              <tr>
                <th class="bg-light">Coordinates</th>
                <td id="modal-coords"></td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Data for JavaScript -->
  <script>
    window.analyticsData = {{ analytics_payload | tojson }};
  </script>
  <script src="{{ url_for('static', filename='js/analytics_details.js') }}"></script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="{{ url_for('static', filename='js/main.js') }}?v={{ range(1, 99999) | random }}"></script>
  <!-- QR Customization Modal -->
  <div class="modal fade" id="qrCustomizeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
      <div class="modal-content overflow-hidden border-0 shadow-lg rounded-4">
        <div class="modal-body p-0">
          <div class="row g-0 h-100">
            <!-- Left Panel: Controls -->
            <div class="col-lg-7 bg-white p-4 p-md-5 overflow-auto" style="max-height: 90vh;">
              <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 class="h4 fw-bold mb-0">Customize QR Design</h3>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>

              <!-- Styles (Patterns) -->
              <div class="mb-5">
                <h5 class="h6 fw-bold mb-3">Patterns</h5>
                <div class="d-flex gap-3 flex-wrap">
                  <div class="style-option p-2 border rounded-3 cursor-pointer selected"
                    onclick="setQrOption('dotsOptions', 'type', 'square', this)">
                    <svg width="40" height="40" viewBox="0 0 40 40" fill="currentColor">
                      <rect width="40" height="40" />
                    </svg>
                  </div>
                  <div class="style-option p-2 border rounded-3 cursor-pointer"
                    onclick="setQrOption('dotsOptions', 'type', 'dots', this)">
                    <svg width="40" height="40" viewBox="0 0 40 40" fill="currentColor">
                      <circle cx="20" cy="20" r="18" />
                    </svg>
                  </div>
                  <div class="style-option p-2 border rounded-3 cursor-pointer"
                    onclick="setQrOption('dotsOptions', 'type', 'rounded', this)">
                    <svg width="40" height="40" viewBox="0 0 40 40" fill="currentColor">
                      <rect x="2" y="2" width="36" height="36" rx="10" />
                    </svg>
                  </div>
                  <div class="style-option p-2 border rounded-3 cursor-pointer"
                    onclick="setQrOption('dotsOptions', 'type', 'extra-rounded', this)">
                    <svg width="40" height="40" viewBox="0 0 40 40" fill="currentColor">
                      <rect x="2" y="2" width="36" height="36" rx="18" />
                    </svg>
                  </div>
                  <div class="style-option p-2 border rounded-3 cursor-pointer"
                    onclick="setQrOption('dotsOptions', 'type', 'classy', this)">
                    <svg width="40" height="40" viewBox="0 0 40 40" fill="currentColor">
                      <path d="M0 0h40v40H0z M20 0v20h20v20h-20v-20h-20z" />
                    </svg>
                  </div>
                  <div class="style-option p-2 border rounded-3 cursor-pointer"
                    onclick="setQrOption('dotsOptions', 'type', 'classy-rounded', this)">
                    <svg width="40" height="40" viewBox="0 0 40 40" fill="currentColor">
                      <path d="M0 0h40v40H0z M20 0v20h20v20h-20v-20h-20z" rx="10" />
                    </svg>
                  </div>
                </div>
              </div>

              <!-- Corners -->
              <div class="mb-5">
                <h5 class="h6 fw-bold mb-3">Corners</h5>
                <div class="d-flex gap-3 flex-wrap">
                  <div class="style-option p-2 border rounded-3 cursor-pointer selected"
                    onclick="setQrOption('cornersSquareOptions', 'type', 'square', this)">
                    <div
                      style="width: 40px; height: 40px; border: 4px solid currentColor; display: grid; place-items: center;">
                      <div style="width: 20px; height: 20px; background: currentColor;"></div>
                    </div>
                  </div>
                  <div class="style-option p-2 border rounded-3 cursor-pointer"
                    onclick="setQrOption('cornersSquareOptions', 'type', 'dot', this)">
                    <div
                      style="width: 40px; height: 40px; border: 4px solid currentColor; border-radius: 50%; display: grid; place-items: center;">
                      <div style="width: 20px; height: 20px; background: currentColor; border-radius: 50%;"></div>
                    </div>
                  </div>
                  <div class="style-option p-2 border rounded-3 cursor-pointer"
                    onclick="setQrOption('cornersSquareOptions', 'type', 'extra-rounded', this)">
                    <div
                      style="width: 40px; height: 40px; border: 4px solid currentColor; border-radius: 12px; display: grid; place-items: center;">
                      <div style="width: 20px; height: 20px; background: currentColor; border-radius: 6px;"></div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Colors -->
              <div class="mb-5">
                <h5 class="h6 fw-bold mb-3">Colors</h5>
                <div class="row g-3">
                  <div class="col-md-6">
                    <label class="form-label small fw-bold">Foreground Color</label>
                    <div class="input-group">
                      <span class="input-group-text p-1"><input type="color"
                          class="form-control form-control-color border-0 p-0" id="qrColorInput" value="#000000"
                          oninput="setQrColor(this.value)"></span>
                      <input type="text" class="form-control" id="qrColorText" value="#000000"
                        oninput="setQrColor(this.value)">
                    </div>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label small fw-bold">Background Color</label>
                    <div class="input-group">
                      <span class="input-group-text p-1"><input type="color"
                          class="form-control form-control-color border-0 p-0" id="qrBgInput" value="#ffffff"
                          oninput="setQrBgColor(this.value)"></span>
                      <input type="text" class="form-control" id="qrBgText" value="#ffffff"
                        oninput="setQrBgColor(this.value)">
                    </div>
                  </div>
                </div>
              </div>

              <!-- Logo -->
              <div class="mb-4">
                <h5 class="h6 fw-bold mb-3">Logo (Optional)</h5>
                <input type="file" class="form-control" accept="image/*" onchange="handleLogoUpload(this)">
                <div class="form-check mt-2">
                  <input class="form-check-input" type="checkbox" value="" id="clearLogo"
                    onchange="if(this.checked) { qrCode.update({image: null}); }">
                  <label class="form-check-label" for="clearLogo">
                    Remove Logo
                  </label>
                </div>
              </div>

            </div>

            <!-- Right Panel: Preview -->
            <div
              class="col-lg-5 bg-light d-flex flex-column align-items-center justify-content-center p-5 border-start">
              <h5 class="h6 text-muted mb-4">Live Preview</h5>
              <div class="bg-white p-4 rounded-4 shadow-sm mb-4" id="qr-preview-container">
                <!-- QR Canvas will be injected here -->
              </div>
              <div class="d-flex gap-2 w-100 max-w-sm justify-content-center">
                <button class="btn btn-outline-secondary rounded-pill px-4"
                  onclick="qrCode.update({ dotsOptions: { type: 'square' }, cornersSquareOptions: { type: 'square' }, backgroundOptions: { color: '#ffffff' }, dotsOptions: { color: '#000000' } }); resetInputs();">
                  Reset
                </button>
                <button class="btn btn-primary rounded-pill px-5 shadow-sm" onclick="downloadQr()">
                  Download PNG
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <style>
    .style-option {
      transition: all 0.2s;
      opacity: 0.7;
    }

    .style-option:hover {
      opacity: 1;
      background-color: #f8fafc;
    }

    .style-option.selected {
      opacity: 1;
      border-color: var(--bs-primary) !important;
      background-color: rgba(var(--bs-primary-rgb), 0.05);
      color: var(--bs-primary);
    }
  </style>

  <script>
    // Initialize QR Code Styling instance
    let qrCode;
    const linkUrl = "{{ url_for('links.redirect_link', code=link.code, _external=True) }}";

    document.addEventListener('DOMContentLoaded', function () {
      qrCode = new QRCodeStyling({
        width: 300,
        height: 300,
        type: "svg",
        data: linkUrl,
        image: "",
        dotsOptions: {
          color: "#000000",
          type: "square"
        },
        backgroundOptions: {
          color: "#ffffff",
        },
        imageOptions: {
          crossOrigin: "anonymous",
          margin: 5
        }
      });

      // Append to preview container
      qrCode.append(document.getElementById("qr-preview-container"));
    });

    // Helper to update options
    function setQrOption(category, key, value, element) {
      // Update visual selection
      if (element) {
        const siblings = element.parentElement.children;
        for (let sib of siblings) sib.classList.remove('selected');
        element.classList.add('selected');
      }

      const options = {};
      options[category] = {};
      options[category][key] = value;

      // Ensure corners match if we are changing patterns, or keep them consistent
      if (category === 'dotsOptions' && key === 'type') {
        // Optional: you can sync corner styles or leave them independent
      }

      qrCode.update(options);
    }

    // Color setters with input syncing
    function setQrColor(color) {
      document.getElementById('qrColorInput').value = color;
      document.getElementById('qrColorText').value = color;
      qrCode.update({
        dotsOptions: { color: color },
        cornersSquareOptions: { color: color },
        cornersDotOptions: { color: color }
      });
    }

    function setQrBgColor(color) {
      document.getElementById('qrBgInput').value = color;
      document.getElementById('qrBgText').value = color;
      qrCode.update({
        backgroundOptions: { color: color }
      });
    }

    // Logo Upload
    function handleLogoUpload(input) {
      if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function (e) {
          qrCode.update({
            image: e.target.result
          });
          document.getElementById('clearLogo').checked = false;
        }
        reader.readAsDataURL(input.files[0]);
      }
    }

    function resetInputs() {
      document.getElementById('qrColorInput').value = "#000000";
      document.getElementById('qrColorText').value = "#000000";
      document.getElementById('qrBgInput').value = "#ffffff";
      document.getElementById('qrBgText').value = "#ffffff";
      // Reset selection visuals manually if needed, or simple reload
    }

    function downloadQr() {
      qrCode.download({ name: "smart-link-qr", extension: "png" });
    }

    async function downloadPDF() {
      const { jsPDF } = window.jspdf;
      const element = document.body; // Capture the whole page

      // visual feedback
      const btn = document.querySelector('button[onclick="downloadPDF()"]');
      const originalText = btn.innerHTML;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Generating...';
      btn.disabled = true;

      try {
        const canvas = await html2canvas(element, {
          scale: 2, // Improve quality
          useCORS: true, // Handle cross-origin images
          logging: false,
          windowWidth: element.scrollWidth,
          windowHeight: element.scrollHeight
        });

        const imgData = canvas.toDataURL('image/png');
        const pdf = new jsPDF('p', 'mm', 'a4');
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = pdf.internal.pageSize.getHeight();
        const imgWidth = pdfWidth;
        const imgHeight = (canvas.height * imgWidth) / canvas.width;

        let heightLeft = imgHeight;
        let position = 0;

        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
        heightLeft -= pdfHeight;

        while (heightLeft >= 0) {
          position = heightLeft - imgHeight;
          pdf.addPage();
          pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
          heightLeft -= pdfHeight;
        }

        pdf.save('analytics-report-{{ link.code }}.pdf');
      } catch (err) {
        console.error("PDF generation failed:", err);
        alert("Failed to generate PDF. Check console for details.");
      } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
      }
    }
  </script>
</body>

</html>