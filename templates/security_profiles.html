{% extends "base.html" %}

{% block title %}Security Profiles - Smart Link Intelligence{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row mb-4 animate__animated animate__fadeIn">
        <div class="col-md-8">
            <h2 class="fw-bold mb-1">
                <i class="bi bi-shield-lock-fill text-primary me-2"></i>Security Profiles
            </h2>
            <p class="text-muted">Master-level DDoS protection and behavioral security customization</p>
        </div>
        <div class="col-md-4 text-md-end">
            <button class="btn btn-primary shadow-sm" data-bs-toggle="modal" data-bs-target="#createProfileModal">
                <i class="bi bi-plus-circle me-2"></i>New Security Profile
            </button>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-sm overflow-hidden animate__animated animate__fadeInUp">
                <div class="card-body p-0">
                    {% if profiles %}
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="bg-light">
                                <tr>
                                    <th class="ps-4">Profile Name</th>
                                    <th>Link Requests</th>
                                    <th>IP Limits</th>
                                    <th>Bot Strictness</th>
                                    <th class="text-end pe-4">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for profile in profiles %}
                                <tr>
                                    <td class="ps-4">
                                        <div class="d-flex align-items-center">
                                            <div class="profile-icon me-3 bg-{{ 'primary' if profile.is_default else 'light' }} text-{{ 'white' if profile.is_default else 'primary' }} rounded-circle d-flex align-items-center justify-content-center"
                                                style="width: 38px; height: 38px;">
                                                <i class="bi bi-shield-check"></i>
                                            </div>
                                            <div>
                                                <span class="fw-bold d-block">{{ profile.profile_name }}</span>
                                                {% if profile.is_default %}
                                                <span
                                                    class="badge bg-primary-soft text-primary tiny-badge">Default</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="text-dark fw-medium">{{ profile.requests_per_link_per_minute
                                            }}</span>
                                        <small class="text-muted">/min</small>
                                    </td>
                                    <td>
                                        <div>
                                            <span class="badge bg-info-soft text-info">{{
                                                profile.requests_per_ip_per_minute }}/min</span>
                                            <span class="badge bg-info-soft text-info">{{
                                                profile.requests_per_ip_per_hour }}/hr</span>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="d-flex flex-column">
                                            <small class="text-muted">Rapid Limit: {{ profile.rapid_click_limit
                                                }}s</small>
                                            <small class="text-muted">Kill Threshold: {{ profile.health_kill_switch }}
                                                hits</small>
                                        </div>
                                    </td>
                                    <td class="text-end pe-4">
                                        {% if not profile.is_default %}
                                        <form method="POST"
                                            action="{{ url_for('ddos.set_default_security_profile', profile_id=profile.id) }}"
                                            class="d-inline">
                                            <button type="submit" class="btn btn-sm btn-outline-success"
                                                title="Set as Default">
                                                <i class="bi bi-star"></i>
                                            </button>
                                        </form>
                                        {% endif %}

                                        <button type="button" class="btn btn-sm btn-outline-primary"
                                            title="Edit Profile" data-bs-toggle="modal"
                                            data-bs-target="#editProfileModal" data-profile-id="{{ profile.id }}"
                                            data-profile-name="{{ profile.profile_name }}"
                                            data-ip-min="{{ profile.requests_per_ip_per_minute }}"
                                            data-ip-hour="{{ profile.requests_per_ip_per_hour }}"
                                            data-link-min="{{ profile.requests_per_link_per_minute }}"
                                            data-burst="{{ profile.burst_threshold }}"
                                            data-suspicious="{{ profile.suspicious_threshold }}"
                                            data-ddos="{{ profile.ddos_threshold }}"
                                            data-rapid-click="{{ profile.rapid_click_limit }}"
                                            data-health-kill="{{ profile.health_kill_switch }}"
                                            data-detection-window="{{ profile.detection_window_minutes }}">
                                            <i class="bi bi-pencil"></i>
                                        </button>

                                        {% if not profile.is_default %}
                                        <form method="POST"
                                            action="{{ url_for('ddos.delete_security_profile', profile_id=profile.id) }}"
                                            class="d-inline"
                                            onsubmit="return confirm('Are you sure you want to delete this profile?')">
                                            <button type="submit" class="btn btn-sm btn-outline-danger"
                                                title="Delete Profile">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </form>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="bi bi-shield-lock fs-1 text-muted mb-3"></i>
                        <h5>No Custom Profiles</h5>
                        <p class="text-muted">Security Profiles allow you to customize how our AI protects your links.
                        </p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Detailed Parameter Explanation Guide -->
    <div class="row mt-5 mb-5 animate__animated animate__fadeInUp" style="animation-delay: 0.2s;">
        <div class="col-12">
            <div class="card border-0 shadow-lg rounded-4 overflow-hidden">
                <div class="card-header bg-dark py-3 px-4">
                    <div class="d-flex align-items-center">
                        <div class="bg-primary bg-opacity-10 p-2 rounded-3 me-3">
                            <i class="bi bi-shield-shaded text-primary fs-4"></i>
                        </div>
                        <h4 class="fw-bold mb-0 text-white">Security Infrastructure Guide</h4>
                    </div>
                </div>
                <div class="card-body p-4 bg-light">
                    <div class="row g-4">
                        <!-- Left Column: Volumetric -->
                        <div class="col-lg-6">
                            <div class="d-flex align-items-center mb-3">
                                <i class="bi bi-speedometer2 text-primary me-2 fs-5"></i>
                                <h5 class="fw-bold mb-0 text-dark">Volumetric Limits (Traffic Volume)</h5>
                            </div>
                            <div class="d-grid gap-3">
                                <div class="p-3 bg-white rounded-3 shadow-sm border-start border-primary border-4">
                                    <h6 class="fw-bold text-dark mb-1">1. Requests per IP (Minute)</h6>
                                    <p class="small text-muted mb-0">A hard limit for a single device. If an IP hits
                                        your link too frequently, the system will temporarily block that specific source
                                        to prevent rapid-fire scraping.</p>
                                </div>
                                <div class="p-3 bg-white rounded-3 shadow-sm border-start border-primary border-4">
                                    <h6 class="fw-bold text-dark mb-1">2. Requests per IP (Hour)</h6>
                                    <p class="small text-muted mb-0">A long-term safety net. Stops bots that try to
                                        circumvent minute-limits by spacing out their requests over several hours.</p>
                                </div>
                                <div class="p-3 bg-white rounded-3 shadow-sm border-start border-primary border-4">
                                    <h6 class="fw-bold text-dark mb-1">3. Requests per Link (Minute)</h6>
                                    <p class="small text-muted mb-0">The <strong>"Global Valve."</strong> Limits the
                                        total traffic allowed across all users. This prevents viral spikes or massive
                                        botnets from overwhelming your target destination.</p>
                                </div>
                                <div class="p-3 bg-white rounded-3 shadow-sm border-start border-primary border-4">
                                    <h6 class="fw-bold text-dark mb-1">4. Burst Threshold (10s)</h6>
                                    <p class="small text-muted mb-0">Monitors micro-spikes. If a user triggers a massive
                                        number of hits in just 10 seconds, the AI identifies it as a script and flags it
                                        immediately.</p>
                                </div>
                            </div>
                        </div>

                        <!-- Right Column: Behavioral -->
                        <div class="col-lg-6">
                            <div class="d-flex align-items-center mb-3">
                                <i class="bi bi-robot text-danger me-2 fs-5"></i>
                                <h5 class="fw-bold mb-0 text-dark">Bot & DDoS Logic (Behavioral)</h5>
                            </div>
                            <div class="d-grid gap-3">
                                <div class="p-3 bg-white rounded-3 shadow-sm border-start border-danger border-4">
                                    <h6 class="fw-bold text-dark mb-1">5. Suspicious Threshold</h6>
                                    <p class="small text-muted mb-0">Accumulates "Suspicious Points" for behavioral
                                        anomalies. Once a visitor hits this threshold, they are officially flagged in
                                        your analytics.</p>
                                </div>
                                <div class="p-3 bg-white rounded-3 shadow-sm border-start border-danger border-4">
                                    <h6 class="fw-bold text-dark mb-1">6. DDoS Block Threshold</h6>
                                    <p class="small text-muted mb-0">The <strong>"Red Alert"</strong> trigger. If
                                        suspicious activity reaches this count within your detection window, the link
                                        engages full defensive protocols.</p>
                                </div>
                                <div class="p-3 bg-white rounded-3 shadow-sm border-start border-danger border-4">
                                    <h6 class="fw-bold text-dark mb-1">7. Rapid Click Buffer (sec)</h6>
                                    <p class="small text-muted mb-0">The <strong>"Human Speed"</strong> test. Humans
                                        rarely click faster than 0.3s apart. Millisecond-level clicks are flagged as
                                        automated bot behavior.</p>
                                </div>
                                <div class="p-3 bg-white rounded-3 shadow-sm border-start border-danger border-4">
                                    <h6 class="fw-bold text-dark mb-1">8. Health Kill Switch</h6>
                                    <p class="small text-muted mb-0">The ultimate safeguard. If severe security
                                        violations are detected, the system <strong>automatically deactivates</strong>
                                        the link to protect your assets.</p>
                                </div>
                                <div class="p-3 bg-white rounded-3 shadow-sm border-start border-secondary border-4">
                                    <h6 class="fw-bold text-dark mb-1">9. Detection Window</h6>
                                    <p class="small text-muted mb-0">Defines the retro-active analysis period (in
                                        minutes). A smaller window makes the system react faster to modern, high-speed
                                        attacks.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-footer bg-white border-0 py-3 text-center">
                    <span class="badge bg-warning bg-opacity-10 text-warning px-3 py-2 rounded-pill">
                        <i class="bi bi-lightbulb-fill me-1"></i>
                        <strong>Pro-Tip:</strong> Defaults are optimized for a "High-Security" balance to stop 99% of
                        bots without affecting real users.
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Configuration Blueprints Section -->
    <div class="row g-4 mb-5 animate__animated animate__fadeInUp" style="animation-delay: 0.3s;">
        <!-- Blueprint 1: Viral Event -->
        <div class="col-xl-6">
            <div class="card border-primary border-opacity-25 bg-primary bg-opacity-10 rounded-4 overflow-hidden h-100">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center mb-4">
                        <div class="bg-primary p-2 rounded-3 me-3">
                            <i class="bi bi-cpu text-white fs-4"></i>
                        </div>
                        <div>
                            <h5 class="fw-bold mb-0 text-primary text-uppercase small ls-wide">High Performance</h5>
                            <h6 class="fw-bold mb-0 text-dark">Blueprint: "Viral Event"</h6>
                        </div>
                    </div>

                    <div class="bg-white rounded-3 p-3 border shadow-sm mb-4">
                        <div class="row g-0 text-center">
                            <div class="col-4 border-end border-bottom py-2"><small
                                    class="d-block text-muted">IP/M</small><span class="fw-bold">120</span></div>
                            <div class="col-4 border-end border-bottom py-2"><small
                                    class="d-block text-muted">IP/H</small><span class="fw-bold">3K</span></div>
                            <div class="col-4 border-bottom py-2"><small class="d-block text-muted">Link/M</small><span
                                    class="fw-bold text-primary">6K</span></div>
                            <div class="col-4 border-end border-bottom py-2"><small
                                    class="d-block text-muted">Burst</small><span class="fw-bold">1K</span></div>
                            <div class="col-4 border-end border-bottom py-2"><small
                                    class="d-block text-muted">Susp.</small><span class="fw-bold">15</span></div>
                            <div class="col-4 border-bottom py-2"><small class="d-block text-muted">DDoS</small><span
                                    class="fw-bold">100</span></div>
                            <div class="col-4 border-end py-2"><small class="d-block text-muted">Rapid</small><span
                                    class="fw-bold">0.2s</span></div>
                            <div class="col-4 border-end py-2"><small class="d-block text-muted">Kill</small><span
                                    class="fw-bold">20</span></div>
                            <div class="col-4 py-2"><small class="d-block text-muted">Wind.</small><span
                                    class="fw-bold">2m</span></div>
                        </div>
                    </div>
                    <div class="alert bg-white border-0 shadow-sm p-3 mb-0">
                        <p class="small text-muted mb-0"><strong>Behavior:</strong> Enables a link to process
                            <strong>100 clicks/sec</strong>. Designed for high-volume marketing where legitimate traffic
                            comes in massive, rapid waves.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Blueprint 2: Stress Test -->
        <div class="col-xl-6">
            <div class="card border-danger border-opacity-25 bg-danger bg-opacity-10 rounded-4 overflow-hidden h-100">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center mb-4">
                        <div class="bg-danger p-2 rounded-3 me-3">
                            <i class="bi bi-bug-fill text-white fs-4"></i>
                        </div>
                        <div>
                            <h5 class="fw-bold mb-0 text-danger text-uppercase small ls-wide">Testing Mode</h5>
                            <h6 class="fw-bold mb-0 text-dark">Blueprint: "Security Stress Test"</h6>
                        </div>
                    </div>

                    <div class="bg-white rounded-3 p-3 border shadow-sm mb-4">
                        <div class="row g-0 text-center">
                            <div class="col-4 border-end border-bottom py-2"><small
                                    class="d-block text-muted">IP/M</small><span class="fw-bold">2</span></div>
                            <div class="col-4 border-end border-bottom py-2"><small
                                    class="d-block text-muted">IP/H</small><span class="fw-bold">5</span></div>
                            <div class="col-4 border-bottom py-2"><small class="d-block text-muted">Link/M</small><span
                                    class="fw-bold text-danger">5</span></div>
                            <div class="col-4 border-end border-bottom py-2"><small
                                    class="d-block text-muted">Burst</small><span class="fw-bold">2</span></div>
                            <div class="col-4 border-end border-bottom py-2"><small
                                    class="d-block text-muted">Susp.</small><span class="fw-bold">1</span></div>
                            <div class="col-4 border-bottom py-2"><small class="d-block text-muted">DDoS</small><span
                                    class="fw-bold">2</span></div>
                            <div class="col-4 border-end py-2"><small class="d-block text-muted">Rapid</small><span
                                    class="fw-bold">5.0s</span></div>
                            <div class="col-4 border-end py-2"><small class="d-block text-muted">Kill</small><span
                                    class="fw-bold">1</span></div>
                            <div class="col-4 py-2"><small class="d-block text-muted">Wind.</small><span
                                    class="fw-bold">10m</span></div>
                        </div>
                    </div>
                    <div class="alert bg-white border-0 shadow-sm p-3 mb-0">
                        <p class="small text-muted mb-0"><strong>Behavior:</strong> A <strong>"Hair-Trigger"</strong>
                            setup. Security levels will be hit almost instantly. Perfect for demonstrating how the AI
                            flags bots, triggers DDoS blocks, and auto-deactivates links.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Profile Modal -->
<div class="modal fade" id="createProfileModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="bi bi-plus-circle me-2"></i>New Security Profile</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('ddos.create_security_profile') }}">
                <div class="modal-body">
                    <div class="col-12 mb-4">
                        <label class="form-label fw-bold">Profile Name</label>
                        <input type="text" name="profile_name" class="form-control form-control-lg"
                            placeholder="e.g., High Protection, API Shield" required>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <h6 class="fw-bold text-primary mb-3"><i class="bi bi-speedometer2 me-2"></i>Volumetric
                                Limits</h6>
                            <div class="mb-3">
                                <label class="form-label">Requests per IP (Minute)</label>
                                <input type="number" name="requests_per_ip_per_minute" class="form-control" value="60"
                                    min="0">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Requests per IP (Hour)</label>
                                <input type="number" name="requests_per_ip_per_hour" class="form-control" value="1000"
                                    min="0">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Requests per Link (Minute)</label>
                                <input type="number" name="requests_per_link_per_minute" class="form-control"
                                    value="500" min="0">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Burst Threshold (10s)</label>
                                <input type="number" name="burst_threshold" class="form-control" value="100" min="0">
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <h6 class="fw-bold text-danger mb-3"><i class="bi bi-robot me-2"></i>Bot & DDoS Logic</h6>
                            <div class="mb-3">
                                <label class="form-label">Suspicious Threshold</label>
                                <input type="number" name="suspicious_threshold" class="form-control" value="10"
                                    min="0">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">DDoS Block Threshold</label>
                                <input type="number" name="ddos_threshold" class="form-control" value="50" min="0">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Rapid Click Buffer (sec)</label>
                                <input type="number" step="0.1" name="rapid_click_limit" class="form-control"
                                    value="0.3" min="0">
                            </div>
                            <div class="row">
                                <div class="col-6 mb-3">
                                    <label class="form-label text-truncate w-100">Health Kill Switch</label>
                                    <input type="number" name="health_kill_switch" class="form-control" value="5"
                                        min="0">
                                </div>
                                <div class="col-6 mb-3">
                                    <label class="form-label text-truncate w-100">Detection Window</label>
                                    <input type="number" name="detection_window_minutes" class="form-control" value="5"
                                        min="0">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary px-4">Create Profile</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Profile Modal -->
<div class="modal fade" id="editProfileModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title"><i class="bi bi-pencil-square me-2"></i>Edit Security Profile</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="" id="editProfileForm">
                <div class="modal-body">
                    <div class="col-12 mb-4">
                        <label class="form-label fw-bold">Profile Name</label>
                        <input type="text" name="profile_name" id="edit_profile_name"
                            class="form-control form-control-lg" required>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <h6 class="fw-bold text-primary mb-3"><i class="bi bi-speedometer2 me-2"></i>Volumetric
                                Limits</h6>
                            <div class="mb-3">
                                <label class="form-label">Requests per IP (Minute)</label>
                                <input type="number" name="requests_per_ip_per_minute" id="edit_ip_min"
                                    class="form-control" min="0">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Requests per IP (Hour)</label>
                                <input type="number" name="requests_per_ip_per_hour" id="edit_ip_hour"
                                    class="form-control" min="0">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Requests per Link (Minute)</label>
                                <input type="number" name="requests_per_link_per_minute" id="edit_link_min"
                                    class="form-control" min="0">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Burst Threshold (10s)</label>
                                <input type="number" name="burst_threshold" id="edit_burst" class="form-control"
                                    min="0">
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <h6 class="fw-bold text-danger mb-3"><i class="bi bi-robot me-2"></i>Bot & DDoS Logic</h6>
                            <div class="mb-3">
                                <label class="form-label">Suspicious Threshold</label>
                                <input type="number" name="suspicious_threshold" id="edit_suspicious"
                                    class="form-control" min="0">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">DDoS Block Threshold</label>
                                <input type="number" name="ddos_threshold" id="edit_ddos" class="form-control" min="0">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Rapid Click Buffer (sec)</label>
                                <input type="number" step="0.1" name="rapid_click_limit" id="edit_rapid_click"
                                    class="form-control" min="0">
                            </div>
                            <div class="row">
                                <div class="col-6 mb-3">
                                    <label class="form-label text-truncate w-100">Health Kill Switch</label>
                                    <input type="number" name="health_kill_switch" id="edit_health_kill"
                                        class="form-control" min="0">
                                </div>
                                <div class="col-6 mb-3">
                                    <label class="form-label text-truncate w-100">Detection Window</label>
                                    <input type="number" name="detection_window_minutes" id="edit_detection_window"
                                        class="form-control" min="0">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-dark px-4">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const editProfileModal = document.getElementById('editProfileModal');
        if (editProfileModal) {
            editProfileModal.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget;
                const profileId = button.getAttribute('data-profile-id');
                const profileName = button.getAttribute('data-profile-name');
                const ipMin = button.getAttribute('data-ip-min');
                const ipHour = button.getAttribute('data-ip-hour');
                const linkMin = button.getAttribute('data-link-min');
                const burst = button.getAttribute('data-burst');
                const suspicious = button.getAttribute('data-suspicious');
                const ddos = button.getAttribute('data-ddos');
                const rapid = button.getAttribute('data-rapid-click');
                const kill = button.getAttribute('data-health-kill');
                const window = button.getAttribute('data-detection-window');

                const form = document.getElementById('editProfileForm');
                form.action = `/ddos-protection/security-profiles/update/${profileId}`;

                document.getElementById('edit_profile_name').value = profileName;
                document.getElementById('edit_ip_min').value = ipMin;
                document.getElementById('edit_ip_hour').value = ipHour;
                document.getElementById('edit_link_min').value = linkMin;
                document.getElementById('edit_burst').value = burst;
                document.getElementById('edit_suspicious').value = suspicious;
                document.getElementById('edit_ddos').value = ddos;
                document.getElementById('edit_rapid_click').value = rapid;
                document.getElementById('edit_health_kill').value = kill;
                document.getElementById('edit_detection_window').value = window;
            });
        }
    });
</script>

<style>
    .bg-primary-soft {
        background-color: rgba(13, 110, 253, 0.1);
    }

    .bg-info-soft {
        background-color: rgba(13, 202, 240, 0.1);
    }

    .tiny-badge {
        font-size: 0.65rem;
        padding: 2px 6px;
    }
</style>
{% endblock %}